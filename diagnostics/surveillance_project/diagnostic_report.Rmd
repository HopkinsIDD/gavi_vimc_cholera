---
title: "Diagnostic Report for the Surveillance Project Results"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
params: 
  surveillance_project_directory: "/home/kaiyuezou/VIMC_Model/surveillance_project/gavi_vimc_cholera"
  country: c("COD", "GHA", "TZA") #country code specified or all the countries will be used for the diagnostic report
  vac_incid_thresholds: c(1/1000)
  no_vaccination_surveillance_scenario: c("district-estimate")
  args: 'myarg'
---

```{r setup, include=FALSE, dev="CairoPNG", message=FALSE}
# ## For development only 
# params <- new.env()
# params$surveillance_project_directory <- "/home/kaiyuezou/VIMC_Model/surveillance_project/gavi_vimc_cholera"
# params$country <- c("COD", "GHA", "TZA") #country code specified or all the countries will be used for the diagnostic report
# params$vac_incid_thresholds <- c(1/1000)
# params$no_vaccination_surveillance_scenario <- c("district-estimate")

## Try to set the working directory
# knitr::opts_knit$set(root.dir = params$surveillance_project_directory)
setwd(params$surveillance_project_directory)

## The necessary packages 
library(knitr)
knitr::opts_chunk$set(
  cache=TRUE,
  cache.lazy = FALSE,
  echo = FALSE,
  dev="CairoPNG",
  error = FALSE,
  fig.align = "center",
  message = TRUE,
  warning = TRUE
  )
library(dplyr)
library(tidyr)
library(ggplot2)
sf::sf_use_s2(FALSE)
# ocvImpact package
if (!require('ocvImpact', character.only = T)) {
  roxygen2::roxygenise("packages/ocvImpact")
  install.packages("packages/ocvImpact", type = "source", repos = NULL)
  library('ocvImpact', character.only = T)
}
# for the development convenience 
roxygen2::roxygenise("packages/ocvImpact")
install.packages("packages/ocvImpact", type = "source", repos = NULL)
library('ocvImpact', character.only = T)

## Other new packages (mainly for "rgeoboundaries")
chooseCRANmirror(ind = 77)

package_list <- c(
  "fasterize", 
  "remotes",
  "rgeoboundaries", 
  "ggrepel"
)

for (package in package_list) {
  if (!require(package = package, character.only = T)) {
    if (package == "rgeoboundaries"){
      try({
        remotes::install_gitlab("dickoa/rgeoboundaries")
        remotes::install_github("wmgeolab/rgeoboundaries")
      })
    }else{
      install.packages(pkgs = package)
      library(package = package, character.only = T)
    }
  }
}

## Figure Caption Numbering
capFigNo = 1
#Function to add the Figure Number
capFig = function(x){
    x = paste0("Figure ",capFigNo,". ",x)
    capFigNo <<- capFigNo + 1
    x
}

```


# Modeling results summary for `r stringr::str_extract(params$country, "[A-Z]{3}")`
```{r include=FALSE, message=FALSE}
# # Test the current wd
# writeLines(getwd(), "current_wd2.txt")

# Make a cache that saves all the tables and some important parameters 
cache <- new.env()

# Function that helps get the names of all files
ocvImpact::get_filenames(cache = cache, surveillance_project_directory = params$surveillance_project_directory, 
    pre_country = params$country, pre_vac_incid_thresholds = params$vac_incid_thresholds, 
    no_vaccination_surveillance_scenario = params$no_vaccination_surveillance_scenario)

# Functions that aggregate the output across countries
ocvImpact::combine_output(cache = cache, output_to_combine = c("target_table", "time_table"), save_final_output = TRUE)

# Decide the height of the figs
fig_height <- 5 * length(params$country)
```


# True case {.tabset}
## True case by year {.tabset}
### True case by year at threshold 1/1000
```{r true case by year 1/1000, fig.height=fig_height, fig.width=15, fig.cap=capFig("True cases by year")}
if(1/1000 %in% params$vac_incid_thresholds){
  plt <- plot_cases(cache = cache, case_type = "true_case", threshold = 1/1000, cumulative_type = "non_cumulative")
}else{
  plt <- ggplot() + theme_void()
}
plt

```

### True case by year at threshold 1/5000
```{r true case by year 1/5000, fig.height=fig_height, fig.width=15, fig.cap=capFig("True cases by year")}
if(1/5000 %in% params$vac_incid_thresholds){
  plt <- plot_cases(cache = cache, case_type = "true_case", threshold = 1/5000, cumulative_type = "non_cumulative")
}else{
  plt <- ggplot() + theme_void()
}
plt

```

### True case by year at threshold 1/10000
```{r true case by year 1/10000, fig.height=fig_height, fig.width=15, fig.cap=capFig("True cases by year")}
if(1/10000 %in% params$vac_incid_thresholds){
  plt <- plot_cases(cache = cache, case_type = "true_case", threshold = 1/10000, cumulative_type = "non_cumulative")
}else{
  plt <- ggplot() + theme_void()
}
plt

```


# # Function that returns cases plots (case type: true_case, observed_case, averted_tr_case, averted_ob_case) (cumulative_type: non_cumulative, district_level, country_level)
# plt <- plot_cases(cache = cache, case_type = "true_case", threshold = 0.001, cumulative_type = "district_level")

# # Function that returns efficacy plots (compare_type: side-by-side, subtraction) (cumulative_type: non_cumulative, across_year, within_district)
# plt <- plot_efficacy(cache = cache, compare_type = "side-by-side", threshold = 0.001, cumulative_type = "non_cumulative")
